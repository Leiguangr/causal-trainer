generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                 String             @id @default(cuid())
  email              String             @unique
  name               String?
  password           String
  role               String             @default("user") // user, admin
  created_at         DateTime           @default(now())
  updated_at         DateTime           @updatedAt

  quiz_sessions      QuizSession[]
  corrections        Correction[]       @relation("SubmittedCorrections")
  reviews            Correction[]       @relation("ReviewedCorrections")
  generation_batches GenerationBatch[]
}

model Question {
  id                 String      @id @default(cuid())
  scenario           String
  claim              String
  pearl_level        String      // L1, L2, L3
  domain             String      // Markets, Medicine, Law, etc.
  subdomain          String?      // More specific domain (e.g., "Commodities")
  trap_type          String       // CONFOUNDING, REVERSE, SELECTION, etc.
  trap_subtype       String       // More specific subtype
  explanation        String
  difficulty         String       @default("medium") // easy, medium, hard
  ground_truth       String       @default("NO") // YES, NO, AMBIGUOUS
  variables          String?      // JSON string for SQLite: { X, Y, Z[] }
  causal_structure   String?      // Brief description of causal graph (null for AMBIGUOUS)
  key_insight        String?      // One-line takeaway
  wise_refusal       String?      // Complete answer with verdict

  // New metadata fields
  author             String?      // Who made/reviewed the annotation (e.g., "LLM", "admin@example.com")
  hidden_timestamp   String?      // For AMBIGUOUS: temporal/causal ordering question. "N/A" for YES/NO.
  conditional_answers String?      // For AMBIGUOUS: JSON with "Answer if..." sections. "N/A" for YES/NO.

  is_verified         Boolean      @default(false)
  is_llm_generated    Boolean      @default(false)
  source_case         String?      // e.g., "3.15" from BucketLarge-G
  generation_batch_id String?      // Track which batch this came from
  review_notes        String?      // Admin notes during review
  dataset             String       @default("default") // Dataset identifier for grouping questions
  created_at          DateTime     @default(now())
  updated_at          DateTime     @updatedAt

  answers             Answer[]      @relation("QuestionAnswers")
  corrections         Correction[]
  generation_batch    GenerationBatch? @relation(fields: [generation_batch_id], references: [id])
  evaluations        CaseEvaluation[]
}

// =============================================================================
// Unified T3Case table (replaces L1Case, L2Case, L3Case)
// - All cases use the same unified schema structure from Appendix B, Table 9
// - Level-specific differences are handled via pearlLevel field and validation
// - Existing Question table remains intact for legacy data flows.
// =============================================================================

model T3Case {
  id                   String   @id @default(cuid())
  
  // Identity & Metadata (Table 9)
  case_id              String?  // Case reference ID from original benchmark (e.g., "1.1")
  bucket               String?  // Bucket identifier (e.g., "BucketLarge-A")
  pearl_level          String   // "L1", "L2", or "L3"
  domain               String?  // Domain name (e.g., "Medicine", "Economics")
  subdomain            String?  // Optional subdomain specification
  
  // Case Content (Table 9)
  scenario             String   // Description of the situation or problem (1–3 sentences)
  claim                String?  // The causal claim being evaluated (required for L1/L2, optional for L3)
  counterfactual_claim String?  // For L3: "If [X had been different], then [Y]."
  label                String   // Case label (YES/NO/AMBIGUOUS for L1, NO for L2, VALID/INVALID/CONDITIONAL for L3)
  is_ambiguous         Boolean  @default(false) // Whether the case is ambiguous
  
  // Variables (Table 9) - JSON: { X, Y, Z[] } where Z is always an array
  variables            String?  // JSON string: { X: string|object, Y: string|object, Z: string[] }
  
  // Trap Structure (Table 9) - stored as separate fields for easier querying
  trap_type            String?   // Trap type code (W1–W10/S1–S8/A for L1, T1–T17 for L2, F1–F8 for L3)
  trap_type_name       String?  // Human-readable trap type name (optional)
  trap_subtype         String?  // Trap subtype (optional)
  trap_subtype_name    String?  // Human-readable subtype name (optional)
  
  // Reasoning Fields (Table 9)
  difficulty           String   @default("medium") // "Easy", "Medium", or "Hard"
  causal_structure     String?  // Description of the causal graph structure
  key_insight          String?  // One-line memorable takeaway
  
  // Ambiguity Handling (Table 9)
  hidden_timestamp     String?  // Question that reveals temporal/causal ordering (object/string)
  conditional_answers  String?  // Conditional answers for different scenarios (object/array JSON)
  
  // Explanations (Table 9)
  wise_refusal         String?  // Response identifying missing information or biases
  gold_rationale       String?  // Complete explanation of the correct reasoning
  
  // L3-Specific Fields
  invariants           String?  // JSON array of invariant strings (L3 only)
  
  // Assignment 2 Fields (Table 9)
  initial_author       String?  // Student who created the case
  validator            String?  // Student who validated the case
  final_score          Float?   // Quality score (0–10) from rubric evaluation
  
  // Metadata
  dataset              String   @default("default")
  author               String?  // e.g., "LLM"
  source_case          String?  // Optional external ID
  generation_batch_id  String?
  is_verified          Boolean  @default(false)
  created_at           DateTime @default(now())
  updated_at            DateTime @updatedAt

  generation_batch     GenerationBatch? @relation("T3CaseGenerationBatch", fields: [generation_batch_id], references: [id])
  evaluations          CaseEvaluation[]
}

model QuizSession {
  id               String      @id @default(cuid())
  user_id          String
  user             User        @relation(fields: [user_id], references: [id])
  total_questions  Int
  correct_answers  Int         @default(0)
  domains_filter   String?     // JSON array of selected domains
  levels_filter    String?     // JSON array of selected levels
  difficulty       String?     // easy, medium, hard, or null for all
  started_at       DateTime    @default(now())
  completed_at     DateTime?
  
  answers          Answer[]
}

model Answer {
  id                String      @id @default(cuid())
  session_id        String
  session           QuizSession @relation(fields: [session_id], references: [id])
  question_id       String
  question          Question    @relation("QuestionAnswers", fields: [question_id], references: [id])
  selected_type     String
  selected_subtype  String?
  is_correct        Boolean
  is_type_correct   Boolean     // Track if just the type was correct
  time_taken_ms     Int?
  answered_at       DateTime    @default(now())
}

model Correction {
  id                    String      @id @default(cuid())
  question_id           String
  question              Question    @relation(fields: [question_id], references: [id])
  submitted_by_id      String
  submitted_by          User        @relation("SubmittedCorrections", fields: [submitted_by_id], references: [id])
  suggested_type        String?
  suggested_subtype     String?
  suggested_explanation String?
  comment               String?
  status                String      @default("pending") // pending, approved, rejected
  reviewed_by_id        String?
  reviewed_by           User?       @relation("ReviewedCorrections", fields: [reviewed_by_id], references: [id])
  review_note           String?
  created_at            DateTime    @default(now())
  reviewed_at           DateTime?
}

model GenerationBatch {
  id                  String      @id @default(cuid())
  pearl_level         String?     // Target level for this batch (L1, L2, L3, or null for mixed)
  domain              String?     // Target domain for this batch
  requested_count     Int         // How many questions were requested
  generated_count     Int         // How many were actually generated
  approved_count      Int         @default(0) // How many have been verified
  prompt_notes        String?     // Custom instructions for generation
  status              String      @default("pending") // pending, running, completed, failed
  error_message       String?     // Error message if failed
  current_index       Int         @default(0) // Current question being generated
  created_at          DateTime    @default(now())
  completed_at        DateTime?   // When generation finished
  created_by_id       String?     // Admin user ID (optional)
  created_by          User?       @relation(fields: [created_by_id], references: [id])

  questions           Question[]
  t3_cases             T3Case[]    @relation("T3CaseGenerationBatch")
}

// Evaluation Agent observations for proofreading and report aggregation
model CaseEvaluation {
  id                      String      @id @default(cuid())
  question_id             String?
  question                Question?   @relation(fields: [question_id], references: [id], onDelete: Cascade)
  t3_case_id              String?
  t3_case                 T3Case?     @relation(fields: [t3_case_id], references: [id], onDelete: Cascade)
  evaluation_batch_id     String?
  evaluation_batch        EvaluationBatch? @relation(fields: [evaluation_batch_id], references: [id])

  // Structural Analysis
  pearl_level_assessment    String?   // Agent's assessment: CORRECT, INCORRECT, UNCERTAIN
  suggested_pearl_level     String?   // If incorrect, what should it be?
  trap_type_assessment      String?   // CORRECT, INCORRECT, UNCERTAIN
  suggested_trap_type       String?   // If incorrect, what should it be?
  trap_subtype_assessment   String?   // CORRECT, INCORRECT, UNCERTAIN
  suggested_trap_subtype    String?   // If incorrect, what should it be?
  ground_truth_assessment   String?   // CORRECT, INCORRECT, UNCERTAIN
  suggested_ground_truth    String?   // If incorrect, what should it be?

  // Quality Flags
  has_ambiguity            Boolean   @default(false) // Is the scenario/claim ambiguous?
  ambiguity_notes          String?   // Description of ambiguity
  has_logical_issues       Boolean   @default(false) // Logical inconsistencies?
  logical_issue_notes      String?   // Description of issues
  has_domain_errors        Boolean   @default(false) // Factual/domain errors?
  domain_error_notes       String?   // Description of errors
  clarity_score            Int       @default(3)     // 1-5 clarity rating
  difficulty_assessment    String?   // Agent's assessment of difficulty

  // Detailed Analysis
  structural_notes         String?   // Free-form structural analysis
  causal_graph_notes       String?   // Notes on causal structure accuracy
  variable_notes           String?   // Notes on X, Y, Z variable accuracy

  // Model Testing (optional)
  model_test_results       String?   // JSON: { model: string, response: string, correct: boolean }[]

  // Recommendations
  overall_verdict          String    @default("NEEDS_REVIEW") // APPROVED, NEEDS_REVIEW, REJECTED
  suggested_corrections    String?   // Markdown summary of recommended fixes
  priority_level           Int       @default(2) // 1=urgent, 2=normal, 3=minor

  // Report Aggregation Tags
  report_tags              String?   // JSON array of tags for report categorization

  // Rubric-based scoring
  rubric_score             String?   // JSON: RubricScore object with category scores and notes

  created_at               DateTime  @default(now())
  updated_at               DateTime  @updatedAt
}

// Batch tracking for evaluation runs
model EvaluationBatch {
  id                String      @id @default(cuid())
  dataset           String?     // Which dataset to evaluate
  question_filter   String?     // JSON filter criteria
  total_count       Int         // How many questions to evaluate
  completed_count   Int         @default(0)
  status            String      @default("pending") // pending, running, completed, failed
  error_message     String?

  // Report generation
  report_generated  Boolean     @default(false)
  report_content    String?     // Generated markdown report

  created_at        DateTime    @default(now())
  completed_at      DateTime?

  evaluations       CaseEvaluation[]
}
